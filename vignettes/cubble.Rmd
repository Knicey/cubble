---
title: "Getting started with cubble"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{cubble}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE, 
  warning = FALSE,
  out.width = "100%"
)
```

```{r setup, echo = TRUE}
library(dplyr)
library(cubble)
library(ggplot2)
```


Global Historical Climatology Network (GHCN) provides daily climate measures from stations across the world. The dataset `climate_aus` extracts the maximum temperature for `r nrow(climate_aus)` Australian stations in the period 1970 - 1975 and 2016 - 2020 from the full Australian historical records starting from year 1969. `climate_aus` is already in a cubble, with `id` as the key, `date` as the index, and `c(long, lat)` as the coordinates. This vignette shows the basic manipulation of cubble in an example to compares the maximum temperature in these two periods for weather stations in Victoria, Australia.

# Spatial manipulation 

Victoria stations can be subset by the station number: Australia GHCN station number starts with "ASN00" and followed by the [Bureau of Meteorology (BOM) station number](http://www.bom.gov.au/climate/cdo/about/site-num.shtml), where the 2nd and 3rd digit (7th and 8th in the GHCN number) define the state of the station. Victoria stations start from 76 to 90 and filtering Victoria stations is an operation in the spatial dimension. Hence we want to use the nested form:

```{r}
tmax <- climate_aus %>% 
  filter(between(as.numeric(stringr::str_sub(id, 7, 8)), 76, 90))

tmax
```

# Temporal manipulation 

`face_temporal()` switches a spatial (nested) cubble into a temporal (long) one for temporal operations:  The long form cubble is for operations whose output is cross-identified by `key` and `index`. 

We would also like to summarise the daily recording into monthly to smooth the maximum temperature and since it is also a time dimension operation, we can keep using the long form:  

```{r}
tmax <- tmax %>%
  face_temporal() %>%
  group_by(month = lubridate::month(date)) %>%
  summarise(tmax = mean(tmax, na.rm = TRUE))

tmax
```

<!-- `face_spatial()` switches a temporal (long) cubble back to the spatial (nested) one for spatial operations and operations summarising temporal information as per location, for example, calculating the average maximum temperature: -->

# The final step

In the glyph map we are about to create, the four variables (major and minor axis for x and y) need to be in the same table. In cubble, you can move time invariant variable into the long form with `unfold()`:

```{r}
tmax <- tmax %>%  unfold(long, lat)
tmax
```

Now you have seen the basic wrangling with cubble, it is time to make some plots! 
The vignette [Making glyph map](glyph.html) will show you how to plot time series in the space using a glyph map. 


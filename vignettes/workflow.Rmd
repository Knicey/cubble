---
title: "workflow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE, 
  warning = FALSE,
  eval = FALSE
)
```

```{r setup}
library(cubble)
library(tsibble)
library(lubridate)
library(dplyr)
```

# Create a cubble


```{r}
oz_global <- oz_climate  %>% global(station)
oz_zoom <- oz_global %>% zoom(data)
back <- oz_zoom %>% global(station)
```

# Workflow

Some operations: 

  - `dplyr`: `filter`, `mutate`, `summarise`

```{r}
station_wise <- oz_global %>% 
  mutate(start = min(data$date),
         end = max(data$date), 
         prcp_missing = sum(is.na(data$prcp) / length(data$prcp)))

# work
time_wise <- oz_zoom %>% 
  mutate(ym = yearmonth(date)) %>% 
  dplyr::filter(year(ym) >= 2015, station == "ASN00001019") %>% 
  summarise(prcp = sum(prcp, na.rm = TRUE),
            across(tmax:tmin, ~mean(.x, na.rm = TRUE)))
  
# goal: still need to implement group_by
time_wise <- oz_zoom %>% 
  mutate(ym = yearmonth(date)) %>% 
  dplyr::filter(station == "ASN00001019") %>%
  group_by(ym) %>% 
  summarise(across(prcp:tmin, ~mean(.x, na.rm = TRUE)))  


```

## Work with tsibble

- `tsibble`: `as_tsibble`, `index_by`

```{r}
oz_climate_tsibble <- oz_climate %>% tsibble::as_tsibble(index = date, key = station)
oz_global2 <- oz_climate_tsibble %>% global(station)
oz_zoom2 <- oz_global2 %>% zoom(data)


# goal achieved :ta-da:
time_wise2 <- oz_zoom2 %>% 
  filter(lubridate::year(date) >= 2015, station == "ASN00001019") %>% 
  mutate(ym = tsibble::yearmonth(date)) %>% 
  tsibble::index_by(ym) %>% 
  summarise(prcp = sum(prcp, na.rm = TRUE),
            across(tmax:tmin, ~mean(.x, na.rm = TRUE)))

# this is a bit of a hack need to figure out nest/unndest for cubble_df. In find_non_varying_var(), nest keeps iterating until Error: C stack usage  7969520 is too close to the limit for grouped_df
cls <- class(time_wise2)
class(time_wise2) <- cls[cls != "grouped_df"]
time_wise2 %>% global(station)
```


# Old stuff

```{r}
count_var <- function(dt){
  dt %>% 
    as_tibble() %>% 
    pivot_longer(prcp:tavg, names_to = "datatype", values_to = "value") %>% 
    group_by(datatype) %>% 
    # think of a better way to filter out those block missing
    summarise(missing = sum(value, na.rm = TRUE)) %>% 
    filter(missing != 0) %>% nrow()
}

```

* some functions to unnest into a tsibble structure, tried unnest_tsibble/ unnest
* some functions to move variables in/ out of nested list - migrate
* some functions to allow data masking within list
* reproduce old result: think about how would you plot the data with list-column structure

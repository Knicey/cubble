---
title: "workflow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE, 
  warning = FALSE,
  eval = FALSE
)
```

```{r setup}
library(cubble)
library(dplyr)
```

# Create a cubble


```{r}
df <- cubble(climate, station, by = c("station" = "id"))
```

# Workflow

```{r}
count_var <- function(dt){
  dt %>% 
    as_tibble() %>% 
    pivot_longer(prcp:tavg, names_to = "datatype", values_to = "value") %>% 
    group_by(datatype) %>% 
    # think of a better way to filter out those block missing
    summarise(missing = sum(value, na.rm = TRUE)) %>% 
    filter(missing != 0) %>% nrow()
}


out <- df %>% 
  choose(main) %>% 
  nest(-station)  %>%
  mutate(var_recorded = map_dbl(data, count_var)) %>% 
  cubble_join()

chosen <- df %>% choose(main) 

nested <- chosen %>% nest(-station)  

mutated <- nested %>% mutate(var_recorded = map_dbl(data, count_var)) 

joined <- mutated %>% cubble_join()
```

# Workflow of nested structure

```{r}
sample <- nested$station %>% unique() %>% head(5)

expand <- nested %>% 
  filter(station %in% sample) %>% 
  mutate(data = list(fill_gaps(data)))

## some functions to unnest into a tsibble structure, tried unnest_tsibble/ unnest
## some functions to move variables in/ out of nested list
## some functions to allow data masking within list
## reproduce old result: think about how would you plot the data with list-column structure


```


# Use cubble with tidyverts

```{r}
library(tsibbledata)
library(fable)
# raw country sheet
wmap <- rworldmap::getMap(resolution="high")
country <- rgeos::gCentroid(wmap, byid=TRUE) %>% 
  as_tibble(rownames = "Country") %>% 
  filter(Country %in% unique(global_economy$Country))

economy <- global_economy %>%
  filter(Country %in% country$Country)

df <- cubble(economy, country, by = c("Country" = "Country"))

df %>% 
  choose(main) %>% 
  model(arima210 = ARIMA(Exports ~ pdq(2,1,0))) %>% 
  cubble_join()

```


---
title: "2. Data manipulation with cubble"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE, 
  warning = FALSE,
  out.width = "100%"
)
```

```{r setup, echo = FALSE}
library(dplyr)
library(cubble)
library(ggplot2)
library(GGally)
library(sf)
library(s2)
```


Global Historical Climatology Network (GHCN) provides daily climate measures from stations across the world. The dataset `weatherdata::historical_tmax` extracts the maximum temperature for 236 Australian stations from GHCN with starting from year 1969. `weatherdata::historical_tmax` is already in a cubble, with `id` as the key, `date` as the index, and `c(longitude, latitude)` as the coordinates. This vignette shows the basic manipulation of cubble in an example to compares the maximum temperature in two periods: 1971 - 1975 and 2016 - 2020 for weather stations in Victoria, Australia.

# Spatial manipulation 

Victoria stations can be subset by the station number: Australia GHCN station number starts with "ASN00" and followed by the [Bureau of Meteorology (BOM) station number](http://www.bom.gov.au/climate/cdo/about/site-num.shtml), where the 2nd and 3rd digit (7th and 8th in the GHCN number) define the state of the station. Victoria stations start from 76 to 90 and filtering Victoria stations is an operation in the spatial dimension. Hence we want to use the nested form: 

```{r}
tmax <- weatherdata::historical_tmax |>
  filter(between(stringr::str_sub(id, 7, 8), 76, 90))

tmax
```

# Temporal manipulation 

Filtering on the year is an operation on the time dimension, `face_temporal()` switches `tmax` to the long form:  
```{r}
tmax <- tmax |>
  face_temporal() |>
  filter(lubridate::year(date) %in% c(1971:1975, 2016:2020))
tmax
```

We would also like to summarise the daily recording into monthly to smooth the maximum temperature and since it is also a time dimension operation, we can keep using the long form: 

```{r}
tmax <- tmax |>
  group_by(month = lubridate::month(date),
           group = as.factor(ifelse(lubridate::year(date) > 2015,
                                    "2016 ~ 2020","1971 ~ 1975"))) |> 
  summarise(tmax = mean(tmax, na.rm = TRUE))

tmax
```

# Back to spatial

A data quality issue with the `rnoaa` data is that while it records the first and last year recorded of each series without the period of missingness. For example, station `ASN00085279` starts it first record in 1943, pauses for a period from 1946 to 1982, and then resumes it recording till today. We would like to remove stations like this by examining whether the summarised time series has a total of 24 months. This is a station-wise operation and `face_spatial()` can be used to convert the cubble back to the nested form: 

```{r}
tmax <- tmax |> face_spatial() |> filter(nrow(ts) == 24)
tmax
```

# The final step

In the glyph map we are about to create, the four variables (major and minor axis for x and y) need to be in the same table. In cubble, you can move time invariant variable into the long form with `migrate()`:

```{r}
tmax <- tmax |> face_temporal() |> migrate(latitude, longitude)
tmax
```


# Glyph map

The `cubble` package also provides a `geom_glyph()` interface to plot the glyph map. The geometry asks for `x_major`, `y_major`, `x_minor`, and `y_minor` as the required aesthetics: 

```{r}
nsw_vic <- ozmaps::abs_ste |> filter(NAME %in% c("Victoria"))

ggplot() + 
  geom_sf(data = nsw_vic, fill = "transparent", color = "grey", linetype = "dotted") + 
  geom_glyph(data = tmax, 
             aes(x_major = longitude, x_minor = month, 
                 y_major = latitude, y_minor = tmax,
                 group = interaction(id, group), color = group),
             width = 1, height = 0.4) +
  scale_color_brewer(palette = "Dark2") + 
  theme_bw() + 
  coord_sf(xlim = c(141, 150)) + 
  theme(legend.position = "bottom") +
  labs(x = "Longitude", y = "Latitude")

```

Remember that Australia is in the southern hemisphere, so the temperature curves are in U shapes :)

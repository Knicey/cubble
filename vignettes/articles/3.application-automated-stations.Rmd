---
title: "3. Application: Comparing records in automated and traditional weather stations"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  warning = FALSE,
  message = FALSE,
  fig.height = 5,
  fig.width = 10
)
library(cubble)
library(rnoaa)
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
```

An interesting thing about the Australian GHCND weather station data is that some station names are suffixed with "AWS", standing for *Automated Weather Stations*. This draws our interest to investigate how these automated stations differ from the traditional ones. An initial plot of all the automated stations shows that most of them are located in New South Wales, so these stations will be our interest to investigate.

```{r}
nsw_map <- ozmaps::abs_ste %>% filter(NAME == "New South Wales")  

nsw <- ghcnd_stations() %>% 
  filter(str_detect(id, "AS")) %>% 
  rename(lat = latitude, long = longitude, elev = elevation) %>% 
  filter(between(lat, -45, -10), between(long, 110, 155)) %>% 
  filter(element == "TMAX", last_year >= 2020) %>% 
  select(-state, -gsn_flag) %>% 
  filter(s2::s2_lnglat(long, lat) %>% s2::s2_within(nsw_map)) %>% 
  mutate(automated = str_detect(name, "AWS"))
 
plot_map(nsw_map) +
  geom_point(data = nsw, 
             aes(x = long, y = lat, color = automated)) + 
  scale_color_brewer(palette = "Dark2") + 
  ggtitle("New Sourth Wales") + 
  theme_minimal() + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
   coord_sf(xlim = c(141, 154))
```

The color in the map shows whether a station is an automated one or not and we can observe that some automated weather stations are actually close to the traditional ones. This provides a basis to investigate whether numbers recorded by nearby automated and traditional stations match with each other.

The chunk below finds the closest traditional station, if any, that is within 10 kilometer of an automated one.

```{r}
query_nearby <- function(data){

  # meteo_nearby_stations() requires lat_long_df to have column 
  # latitue and longitude
  data <- data %>% 
    rename(latitude = lat, longitude = long)
  
  range <- nsw %>% 
    filter(!automated) %>% 
    rename(latitude = lat, longitude = long)
  
  meteo_nearby_stations(lat_lon_df = data,
                        station_data = range,
                        limit = 1)[[1]] %>%
    select(id, distance) %>%
    rename(matched_id = id)
}

station_matched <- nsw %>%
  filter(automated) %>%
  nest(id, long, lat) %>%
  rowwise() %>%
  mutate(query_nearby(data)) %>%
  unnest(data) %>%
  filter(distance < 10) %>%
  select(id, matched_id) %>%
  mutate(group = row_number()) %>%
  pivot_longer(c(id, matched_id), names_to = "stations", values_to = "id") %>%
  select(-stations) %>%
  left_join(nsw) %>% 
  filter(group != 15)

plot_map(nsw_map) +
  geom_point(data = station_matched, 
             aes(x = long, y = lat, color = automated)) + 
  ggrepel::geom_label_repel(data = station_matched %>% filter(automated),
                            aes(x = long, y = lat, label = group)) + 
  scale_color_brewer(palette = "Dark2") + 
  ggtitle("New Sourth Wales") + 
  theme_minimal() + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) + 
  coord_sf(xlim = c(141, 154))
```

We then query the maximum temperature for these stations in January 2020 and make it into a cubble.

```{r}
climate <- station_matched %>%
  select(-c(element:last_year)) %>% 
  rowwise() %>%
  mutate(ts = list(meteo_pull_monitors(id,
                                       date_min = "2020-01-01",
                                       date_max = "2020-01-31",
                                       var = "TMAX") %>% 
                     select(-id)))

climate_cubble <- climate %>% 
  as_cubble(key = id, index = date, coords = c(long, lat))
climate_cubble
```

Plotting the maximum temperature of each pair shows that in general, recordings from nearby stations match pretty well, except some missing values, i.e. in Pair 6, 11, and 13. Noticeably, there is a constant gap between the automated and traditional recording in Pair 9 and 13 and this would indicate further calibration of the themometer. 

```{r}
climate_cubble %>%
  stretch() %>%
  migrate(group, automated) %>%
  ggplot(aes(x = date, y = tmax, group = id, color = automated)) +
  geom_line() +
  facet_wrap(vars(group)) +
  scale_color_brewer(palette = "Dark2")
```


---
title: "0. Creating a cubble from data in the wild"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  cache = TRUE, 
  warning = FALSE,
  message = FALSE
)

library(cubble)
library(rnoaa)
library(dplyr)
library(tidyr)
library(stringr)
library(patchwork)
library(ggplot2)
library(sf)
```

This article shows you how to create a cubble from data in the wild through an example of querying climate data from National Oceanic and Atmospheric Administration (NOAA). Here I use a workflow involving row-wise data frame making it easy to organise and  turn data into a cubble. This involves first create a row-wise tibble with one row per station, and then query the climate data as a nested list for each station.

# Find target stations

Suppose we want to find a few climate stations close to Melbourne and Sydney, here we create a reference list with the longitude and latitude of both cities:

```{r}
(latlon_ref <- tibble::tibble(id = c("sydney", "melbourne"),
                         lat = c(-33.8675, -37.8136),
                         long = c(151.2070, 144.9631)))
```

Usually, you also need a master list with all the candidate stations to choose from. Here we use the stations saved in the built-in data, `aus_climate`.

```{r}
(cand <- aus_climate %>% 
  select(id, lat, long, elev, name, wmo_id) %>% 
   as_tibble())
```

Now we write a small function to find the 5 closest stations in the master list for both cities. The Euclidean distance is used here for simplicity and it doesn't differ too much from the spherical distance when calculating between nearby points.

```{r}
calc_dist <- function(df_ref, df, n = 5){
  long_ref <- df_ref$long
  lat_ref <- df_ref$lat
  
  df %>% 
    mutate(dist = sqrt((long_ref - long)^2 + (lat_ref - lat)^2)) %>% 
    slice_min(dist, n = n) %>% 
    mutate(city = df_ref$id)
}

(stations <- do.call("rbind", purrr::map(1:nrow(latlon_ref), 
                             ~calc_dist(latlon_ref[.x, ], cand))))
```

# Query weather data

The weather station data can be queried by `rnoaa::meteo_pull_monitors()` with the date range and variable supplied. Here the use of row-wise operation nests the queried climate data into a `ts` column. The nested data is then ready to be turned into a cubble with 

  - `id` as the key to identify each station, 
  - `date` as the index to identify time, and 
  - `coords` to identify the spatial coordinates of each station.

```{r eval = FALSE}
sydmel_climate <- stations %>% 
  rowwise() %>% 
  mutate(ts = list(meteo_pull_monitors(id, 
                                       date_min = "2020-01-01", 
                                       date_max = "2020-12-31",
                                       var = c("PRCP", "TMAX", "TMIN")) %>% 
                     select(-id))) %>% 
  as_cubble(key = id, index = date, coords = c(long, lat))
```

```{r echo = FALSE}
(sydmel_climate <- stations %>% 
   left_join(aus_climate) %>% 
   as_cubble(key = id, index = date, coords = c(long, lat)))
```

# Before you go

Let's look at these stations on the map:

```{r fig.width=10, fig.height=5, echo = FALSE}
syd_map <- absmapsdata::sa42016  %>% filter(gcc_name_2016 == "Greater Sydney")
mel_map <- absmapsdata::sa42016  %>% filter(gcc_name_2016 == "Greater Melbourne")

syd_station <- sydmel_climate %>% filter(city == "sydney")
mel_station <- sydmel_climate %>% filter(city == "melbourne")

p1 <-  plot_map(syd_map) +
  ggrepel::geom_label_repel(
    data = syd_station, 
    aes(x = long, y = lat, label = name),
    max.iter = 1e7, min.segment.length = 0.01, box.padding = 0.5) + 
  geom_point(data = syd_station, aes(x = long, y = lat)) + 
  theme_minimal() + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) + 
  ggtitle("Sydney")

p2 <- plot_map(mel_map) +
  ggrepel::geom_label_repel(
    data = mel_station,  
    aes(x = long, y = lat, label = name), 
    max.iter = 1e7, min.segment.length = 0.1) + 
  geom_point(data = mel_station, aes(x = long, y = lat)) + 
  theme_minimal() + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) + 
  ggtitle("Melbourne")

p1 | p2
```

---
title: "0. Creating a cubble from data in the wild"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  cache = TRUE, 
  warning = FALSE,
  message = FALSE
)

library(cubble)
library(rnoaa)
library(dplyr)
library(patchwork)
library(ggplot2)
library(sf)
```

This article shows you how to create a cubble from data in the wild through an example of querying climate data from National Oceanic and Atmospheric Administration (NOAA). Here row-wise data frame is used to organise the data before turning it into a cubble. The row-wise data frame is constructed by first creating a row-wise data frame with all the metadata and then querying the climate data as a nested list.

# Construct the meta dataset

Suppose we are interested in the climate stations close to Melbourne and Sydney, here are ten of them: 

```{r echo = FALSE}
latlon_ref <- tibble::tibble(id = c("sydney", "melbourne"),
                         lat = c(-33.8675, -37.8136),
                         long = c(151.2070, 144.9631))

master_list <- aus_climate %>% 
   as_tibble() %>% 
   select(id, lat, long, elev, name, wmo_id)

calc_dist <- function(df_ref, df, n = 5){
  long_ref <- df_ref$long
  lat_ref <- df_ref$lat
  
  df %>% 
    mutate(long_ref = long_ref,
           lat_ref=  lat_ref,
           dist = rnoaa::meteo_spherical_distance(lat, long,lat_ref, long_ref)) %>% 
    slice_min(dist, n = n) %>% 
    mutate(city = df_ref$id) %>% 
    select(-long_ref, -lat_ref)
}

stations <- do.call("rbind", purrr::map(1:nrow(latlon_ref), 
                             ~calc_dist(latlon_ref[.x, ], master_list)))
```

```{r}
stations
```

This datasets contains the station id and a few meta information of the station: `lat`, `long`, `elev`, `name`, `wmo_id` (World Meteorology Organisation ID) and its distance to Melbourne and Sydney city center.

Such a dataset can be constructed via subsetting a station master list, i.e. `rnoaa::ghcnd_stations()`, with some criteria on variable, distance and recording years.


# Query weather data

The time series of climate variables can be queried by `rnoaa::meteo_pull_monitors()` with the date range and variable supplied. Here we turn the `stations` data into a rowwise data frame and then query the climate variables as a list-column, `ts`:  

```{r}
raw <- stations %>% 
  rowwise() %>% 
  mutate(ts = list(rnoaa::meteo_pull_monitors(id, 
                                       date_min = "2020-01-01", 
                                       date_max = "2020-12-31",
                                       var = c("PRCP", "TMAX", "TMIN")))) 
```

The nested data is then ready to be turned into a cubble with 

  - `id` as the key to identify each station, 
  - `date` as the index to identify time, and 
  - `coords` to identify the spatial coordinates of each station.

```{r}
sydmel_climate <- raw %>% 
  as_cubble(key = id, index = date, coords = c(long, lat))
```


# Before you go

Let's look at these stations on the map:

```{r fig.width=10, fig.height=5, echo = FALSE}
syd_map <- absmapsdata::sa42016  %>% filter(gcc_name_2016 == "Greater Sydney")
mel_map <- absmapsdata::sa42016  %>% filter(gcc_name_2016 == "Greater Melbourne")

syd_station <- sydmel_climate %>% filter(city == "sydney")
mel_station <- sydmel_climate %>% filter(city == "melbourne")

p1 <-  plot_map(syd_map) +
  ggrepel::geom_label_repel(
    data = syd_station, 
    aes(x = long, y = lat, label = name),
    max.iter = 1e7, min.segment.length = 0.01, box.padding = 0.5) + 
  geom_point(data = syd_station, aes(x = long, y = lat)) + 
  theme_minimal() + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) + 
  ggtitle("Sydney")

p2 <- plot_map(mel_map) +
  ggrepel::geom_label_repel(
    data = mel_station,  
    aes(x = long, y = lat, label = name), 
    max.iter = 1e7, min.segment.length = 0.1) + 
  geom_point(data = mel_station, aes(x = long, y = lat)) + 
  theme_minimal() + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) + 
  ggtitle("Melbourne")

p1 | p2
```

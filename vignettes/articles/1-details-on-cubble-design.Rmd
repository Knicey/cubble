---
title: "1. details-on-cubble-design"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(cubble)
library(dplyr)
```

A cubble has its own attributes `leaves` and `form`: 

* `leaves` contains the list of variables that are time-invariant to the site; 
* `form` specifies whether the data object is in the nested or long form. 

## Nested cubble

A nested cubble is built on top of a `rowwise_df`, which comes with the `groups` attributes, as well as the usual `names`, `row.names`, and `class`. Note that the `class` attribute contains the history class that a `rowwise_df` is built upon: `tbl_df`, `tbl` and `data.frame`. This is an example of the attributes for a nested cubble: 

```{r}
nested <- climate_flat %>% 
  as_cubble(key = id, index = date, coords = c(long, lat))
nested
attributes(nested)
```

In this example, two stations recorded are `ASN00001019` and `ASN00002012`. 

The `rowwise_df` class uses a `group` attributes to ensure each row is in its own group and this structure makes it simpler to calculate on the list. For example calculating the number of non-raining day can be done by: 

```{r}
climate_flat %>%
  as_cubble(key = id, index = date, coords = c(long, lat)) %>%  # cubble names the list-column as `ts` rather than `data`
  mutate(rain = sum(ts$prcp != 0, na.rm = TRUE))
```

which matches the basic mutate style of calculation, so it is easier to remember than the purrr style syntax: 

```{r}
climate_flat %>% 
  tidyr::nest(c(date, prcp, tmax, tmin)) %>% 
  mutate(rain = purrr::map_dbl(data, ~sum(.x$prcp != 0, na.rm= TRUE)))
```

The `leaves` attribute records the time-invariant variables to ensure a cubble can be switch between the nested and long form. The `leaves` attribute itself has two attributes `invariant` and `variant`, which contains both types of variables as seen below: 

```{r}
leaves(nested)
leaves(nested) %>% invariant()
leaves(nested) %>% variant()
```

In this dataset, variables that are invariant to time include `lat`, `long`, `elevation` and `name` while those vary across time include `date`, `prcp`, `tmax`, and `tmin`. Notice that although time-variant variables are not directly shown in the nested form, they can be read from the third line of the cubble header:

```{r}
nested
```


## Long cubble

A long form cubble is built from a `grouped_df`, instead of `rowwise_df`. `grouped_df` ensures records of all the timestamps from a "spot" is in the same group. Below prints the attributes of a long cubble:

```{r}
long <- nested %>% stretch()
long
attributes(long)
```

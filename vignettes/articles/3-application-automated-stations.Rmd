---
title: "3. Application: Comparing records in automated and traditional weather stations"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  warning = FALSE,
  message = FALSE,
  fig.height = 5,
  fig.width = 10
)
library(cubble)
library(rnoaa)
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(sf)
library(patchwork)
```

An interesting thing about the Australian GHCND weather station data is that some station names are suffixed with "aws", standing for *Automated Weather Stations*. This draws our interest to investigate how these automated stations differ from the traditional ones. Most of these automated stations are located in New South Wales, so we will look at pairs there.

```{r}
nsw_map <- ozmaps::abs_ste %>% filter(NAME == "New South Wales")  

nsw <- aus_climate %>%   
  filter(s2::s2_lnglat(long, lat) %>% s2::s2_within(nsw_map)) %>% 
  mutate(automated = str_detect(name, "aws"))
 
plot_map(nsw_map) +
  geom_point(data = nsw, 
             aes(x = long, y = lat, color = automated)) + 
  scale_color_brewer(palette = "Dark2") + 
  ggtitle("New Sourth Wales") + 
  theme_minimal() + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
   coord_sf(xlim = c(141, 154))
```

The color in the map shows whether a station is an automated one or not and we can observe that some automated weather stations are actually close to the traditional ones. This provides a basis to investigate whether numbers recorded by nearby automated and traditional stations match with each other.

The chunk below finds the closest traditional station, if any, that is within 10 kilometer of an automated one.

```{r}
query_nearby <- function(df_ref, df, n = 1){

  # check long and lat column in df_ref
  
  df %>% 
    as_tibble() %>% 
    mutate(long_ref = df_ref$long,
           lat_ref=  df_ref$lat,
           dist = rnoaa::meteo_spherical_distance(lat, long,
                                                  lat_ref, 
                                                  long_ref)) %>% 
    slice_min(dist, n = n) %>% 
    select(-long_ref, -lat_ref)
}

auto <- nsw %>% filter(automated)
non_auto <- nsw %>% filter(!automated)

(stations <- do.call("bind_rows", purrr::map(1:nrow(auto), 
                             ~query_nearby(auto[.x, ], non_auto) %>% mutate(matched = auto$id[.x]))))
```

Here are some post-processing to join the aws stations with non-aws.

```{r}
matched_non <- stations %>% 
  filter(dist < 10) %>% 
  mutate(group = row_number())

matched_auto <- auto %>% 
  filter(id %in% matched_non$matched) %>% 
  left_join(matched_non %>% select(matched, group, dist), 
            by = c("id" = "matched"))

(matched_both <- matched_auto %>% bind_rows(matched_non) %>% 
  select(-matched) %>% 
  as_cubble(key = id, index = date, coords = c(long, lat)))
```

Now there are various things we can do with this data, i.e. lets look at those pairs in the map:

```{r echo = FALSE}
p1 <- plot_map(nsw_map) +
  geom_point(data = matched_both, 
             aes(x = long, y = lat, color = automated)) + 
  ggrepel::geom_label_repel(data = matched_auto,
                            aes(x = long, y = lat, label = group)) + 
  scale_color_brewer(palette = "Dark2") + 
  ggtitle("New Sourth Wales") + 
  theme_minimal() + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  coord_sf(xlim = c(141, 154))

ts <- matched_both %>%
  stretch(ts) %>%
  filter(lubridate::month(date) == 1) %>% 
  migrate(group, automated) 

p2 <- ts %>%
  ggplot(aes(x = date, y = tmax,color = automated, group = id)) +
  geom_line() +
  facet_wrap(vars(group)) +
  scale_color_brewer(palette = "Dark2") + 
  theme(legend.position = "none")

(p1 | p2) + plot_layout(guides = "collect")
```

Plotting the maximum temperature of each pair shows that in general, recordings from nearby stations match pretty well, except some missing values, i.e. in Pair 6, 11, and 13. Noticeably, there is a constant gap between the automated and traditional recording in Pair 9 and 13 and this would indicate further calibration of the themometer. 


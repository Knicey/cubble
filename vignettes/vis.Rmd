---
title: "vis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{vis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(cubble)
library(tsibble)
library(lubridate)
library(ggplot2)
library(ggmap)
library(dplyr)
library(forcats)
library(ggrepel)
library(GGally)
```

# Set up `cubble_df` object

```{r}
oz_climate_tsibble <- oz_climate %>% as_tsibble(index = date, key = station)
oz_global2 <- oz_climate_tsibble %>% global(station)
oz_zoom2 <- oz_global2 %>% zoom()
```


# Summary

- Rendering less than 100 stations for 1 year worth of daily data is still slow. Try to sample a few stations to plot first but `brolgar::sample_n_keys()` doesn't work for grouped data. Either have my own sampling function or make changes on `brolgar`. 

- Some stations have block missing for `tmax`, can filter out those bad stations in the list-column form before plotting with the long form data (still a minor fix is needed).

- Glyph map needs both station-wise and time-wise information to make, so would be nice to have a `migrate` function that add station wise info to the long format.


# Plots

## Plot with list-column format

### Can make a geographic map: :)

```{r}
aus_map <- get_map(location = bbox(station), source = "osm")
ggmap(aus_map) + geom_point(data = oz_global2, aes(x = long, y = lat))
```

### Data quality plots

```{r}
# add missing proportion
global2_2020 <- oz_zoom2 %>% 
  filter(year(date) == 2020) %>%
  global() %>% 
  add_missing_prct(prcp:tmin) %>% 
  add_missing_dscrb()

# add number of variables that are block missing for ordering
global2_quality <- global2_2020 %>% 
  mutate(missing_num = sum(c_across(ends_with("missing")) == "almost all missing")) %>% 
  tidyr::pivot_longer(prcp_missing:tmin_missing, names_to = "var", values_to = "value")
 

global2_quality %>% 
  ggplot(aes(x = value, y = fct_reorder(station, -missing_num), color = var)) + 
  geom_point()


# add the maximum % of missing across all variable for each station (for ordering) - block missings are recoded as NA and not counted
global2_quality2 <- global2_2020 %>% 
  mutate(across(ends_with("missing"), ~ifelse(.x > 0.95, NA, .x)), 
         missing_max = max(prcp_missing, tmax_missing, tmin_missing, na.rm = TRUE)) %>% 
  tidyr::pivot_longer(prcp_missing:tmin_missing, names_to = "var", values_to = "value")
 
global2_quality2 %>% 
  ggplot(aes(x = value, y = fct_reorder(station, -missing_max), color = var)) + 
  geom_point()
```

## Plot with long format

### Precipitation

Time series plot seems slow to make for all 93 stations:  

```{r}
oz_zoom2_2020 <- oz_zoom2 %>% filter(year(date) == 2020) 

oz_zoom2_2020 %>% 
  ggplot() + 
  geom_line(aes(x = date, y = prcp, group = station)) + 
  facet_wrap(vars(station)) + 
  theme_void()
```


### Max temperature

Try with `tmax` rather than `prcp`: 

```{r}
oz_zoom2_2020 <- oz_zoom2 %>% dplyr::filter(year(date) == 2020) 

oz_zoom2_2020 %>% 
  ggplot() + 
  geom_line(aes(x = date, y = tmax, group = station)) + 
  facet_wrap(vars(station)) + 
  theme_void()
```

There are block missing for some stations, would be good to have a function to summarise these before filtering

```{r}
oz_zoom2_tmax <- oz_global2 %>% 
  zoom() %>% 
  filter(year(date) == 2020) %>% 
  global() %>% # some work here needs to be done here to make sure after global the list-col is still tsibble
  mutate(tmax_missing = sum(ts$tmax, na.rm = TRUE)) %>% 
  filter(tmax_missing != 0) %>% 
  zoom()

oz_zoom2_tmax %>% 
  ggplot() + 
  geom_line(aes(x = date, y = tmax, group = station)) + 
  facet_wrap(vars(station)) + 
  theme_void()

# aggregate to monthly measures
oz_zoom2_tmax_ym <- oz_zoom2_tmax %>% 
  as_tsibble() %>% 
  mutate(ym = yearmonth(date)) %>% 
  index_by(ym) %>% 
  summarise(across(tmax:tmin, ~mean(.x, na.rm = TRUE))) 

oz_zoom2_tmax_ym %>% 
  ggplot() + 
  geom_line(aes(x = ym, y = tmax, group = station)) + 
  facet_wrap(vars(station)) + 
  theme_void()
```

Can do more aggregation to reduce the noise


### Glyph map


```{r}
oz_zoom2_prep <- oz_zoom2 %>% 
  dplyr::filter(lubridate::year(date) == 2020) %>% 
  mutate(yday = lubridate::yday(date)) %>% 
  mutate(ym = yearmonth(date)) %>% 
  index_by(ym) %>% 
  summarise(across(tmax:tmin, ~mean(.x, na.rm = TRUE))) %>% 
  migrate(lat, long)

gly <- oz_zoom2_prep %>% glyphs("long", "ym", "lat", "tmax", height = 1, width = 2)
aus_map <- get_map(location = bbox(station), source = "osm")

ggmap(aus_map) + 
  # ggplot(gly, aes(x = gx, y = gy,  group = gid)) +
  #add_ref_lines(gly,color = "grey90") +
  #add_ref_boxes(gly, color = "grey90") +
  geom_path(data = gly, aes(x = gx, y = gy, group = gid)) +
  theme_void()
```


```{r}
library(ozmaps)
ozmaps::ozmap_country
ggplot() + 
  geom_sf(data = ozmaps::ozmap_country, aes(geometry = geometry)) + 
  # ggplot(gly, aes(x = gx, y = gy,  group = gid)) +
  #add_ref_lines(gly,color = "grey90") +
  #add_ref_boxes(gly, color = "grey90") +
  geom_path(data = gly, aes(x = gx, y = gy, group = gid)) +
  theme_void()

```


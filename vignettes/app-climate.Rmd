---
title: "app-climate"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{app-climate}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  eval = FALSE
)
```

```{r setup}
library(cubble)
library(tidyverse)
library(ggplot2)
library(fabletools)
library(broom)
library(feasts)
library(rmapshaper)
library(lubridate)
library(patchwork)
library(crosstalk)
library(plotly)
state_map <- ms_simplify(ozmaps::abs_ste, keep = 2e-3)
filter <- dplyr::filter
```

```{r}
df <- oz_climate %>% 
  mutate(name = as.factor(str_to_lower(str_remove(name, ", AS")))) %>% 
  as_tsibble(index = date, key = station) %>% 
  global(station) 
  
#  rename(elev = elevation)
# add rename: https://github.com/tidyverse/dplyr/blob/master/R/rename.R

df_daily <- df %>% 
  mutate(tmax_missing = all(is.na(ts$tmax)),
         tmin_missing = all(is.na(ts$tmin))) %>% 
  filter(!tmax_missing, !tmin_missing, 
         name != "coffs harbour mo",# too many missing from 2016 - 2020 for coffs harbour mo
         !station %in% c("ASN00016098", # almost all missing for tmin
                      "ASN00090015")  # have no prcp recorded (either 0 or NA)
         
         ) 

df_daily %>% 
  zoom() %>% 
  migrate(name) %>% 
  ggplot(aes(x = date ,y = tmax)) + 
  geom_line() + 
  facet_wrap(vars(name))

```

## Location of all the stations

```{r}
ggplot() +  
  geom_sf(data = state_map, aes(geometry = geometry)) +
  geom_point(data = df, aes(x = long, y = lat)) + 
  coord_sf() + 
  theme_void()
```

## Features on tmax

```{r}
feat_tmax <- df_daily %>% 
  tidyr::unnest(ts) %>% 
  as_tsibble(index = date, key = station) %>% 
  features(tmax, feature_set(pkgs = "feasts"))

feat_tmax_clean <- feat_tmax %>% 
  dplyr::select(-contains(c("lb", "bp", "zero", "pp", "diffs", "lambda")))

pca_res <- feat_tmax_clean %>% 
  dplyr::select(-station) %>% 
  prcomp(scale = TRUE) 

pca_tmax <- pca_res %>% 
  augment(feat_tmax_clean)
```

```{r}
df_tmax_pca <- df_daily %>% 
  left_join(pca_tmax %>% dplyr::select(station, .fittedPC1, .fittedPC2)) 

df_tmax_pca %>% 
  ggplot(aes(x = .fittedPC1, y = .fittedPC2)) + 
  geom_point() + 
  coord_equal()
```

think about how to show these three stations are different from others

```{r}
# see those stations on the map
ggplot() +  
  geom_sf(data = state_map, aes(geometry = geometry)) +
  geom_point(data = df, aes(x = long, y = lat)) + 
  geom_point(data = df_tmax_pca %>% filter(.fittedPC1 < -5), 
             aes(x = long, y = lat), color = "red") + 
  coord_sf() + 
  theme_void()

# average across station doesn't work currently :(
average <- df_tmax_pca %>% 
  filter(.fittedPC1 >= -5) %>% 
  zoom() %>%
  as_tibble() %>% 
  group_by(date) %>% 
  summarise(tmax = mean(tmax, na.rm = TRUE)) %>% 
  mutate(name = "average")

# plot the tmax series along with the average of all others - averaging makes the series smoother ....
df_tmax_pca %>% 
  filter(.fittedPC1 < -5) %>% 
  zoom() %>% 
  migrate(name) %>% 
  bind_rows(average) %>% 
  ggplot(aes(x = date , y = tmax)) + 
  geom_line() + 
  facet_wrap(vars(name), ncol = 1)

```

## Features on prcp

```{r}
df_prcp <- df %>% 
  mutate(prcp_missing = all(is.na(ts$prcp) | ts$prcp == 0)) %>% 
  filter(!prcp_missing) 

feat_prcp <- df_prcp %>% 
  tidyr::unnest(ts) %>% 
  as_tsibble(index = date, key = station) %>% 
  features(prcp, feature_set(pkgs = "feasts"))

feat_prcp_clean <- feat_prcp %>% 
  dplyr::select(-contains(c("lb", "bp", "zero", "pp", "diffs", "lambda", "pacf", "kpss", "hurst")))

pca_prcp <- feat_prcp_clean %>% 
  dplyr::select(-station) %>% 
  prcomp(scale = TRUE) %>% 
  augment(feat_prcp_clean)
```

```{r}
df_prcp_pca <- df_prcp %>% 
  left_join(pca_prcp %>% dplyr::select(station, .fittedPC1, .fittedPC2)) 

df_prcp_pca %>% 
  ggplot(aes(x = .fittedPC1, y = .fittedPC2)) + 
  geom_point() + 
  coord_equal()

```

```{r}
# see those stations on the map
ggplot() +  
  geom_sf(data = state_map, aes(geometry = geometry)) +
  geom_point(data = df, aes(x = long, y = lat)) + 
  geom_point(data = df_prcp_pca %>% filter(.fittedPC1 > 4), 
             aes(x = long, y = lat), color = "red") + 
  coord_sf() + 
  theme_minimal()

# plot the tmax series along with the average of all others
df_prcp_pca %>% 
  filter(.fittedPC1 > 4) %>% 
  zoom() %>% 
  migrate(name) %>% 
  ggplot(aes(x = date , y = prcp)) + 
  geom_line() + 
  facet_wrap(vars(name))

```


## Features on tmin

```{r}
df_tmin <- df %>% 
  mutate(tmin_missing = all(is.na(ts$tmin)), 
         first_day = is.na(ts$tmin[1])) %>% 
  filter(!tmin_missing, !first_day) 

feat_tmin <- df_tmin %>% 
  tidyr::unnest(ts) %>% 
  as_tsibble(index = date, key = station) %>% 
  features(tmin, feature_set(pkgs = "feasts"))

feat_tmin_clean <- feat_tmin %>% 
  dplyr::select(-contains(c("lb", "bp", "zero", "pp", "diffs", "lambda", "pacf", "hurst", "kpss", "spikiness"))) %>% 
  filter(station != "ASN00040223")

pca_tmin <- feat_tmin_clean %>% 
  dplyr::select(-station) %>% 
  prcomp(scale = TRUE) %>% 
  augment(feat_tmin_clean)
```

```{r}
df_tmin_pca <- df_tmin %>% 
  left_join(pca_tmin %>% dplyr::select(station, .fittedPC1, .fittedPC2)) 

df_tmin_pca %>% 
  ggplot(aes(x = .fittedPC1, y = .fittedPC2)) + 
  geom_point() + 
  coord_equal()
```

```{r}
# see those stations on the map
ggplot() +  
  geom_sf(data = ozmaps::abs_ste, aes(geometry = geometry)) +
  geom_point(data = df, aes(x = long, y = lat)) + 
  geom_point(data = df_tmin_pca %>% filter(.fittedPC1 > 6), 
             aes(x = long, y = lat), color = "red") + 
  coord_sf() + 
  theme_minimal()
```


## Cross linking on map and PC plot

```{r}
shared_dt <- SharedData$new(df_tmax_pca %>% mutate(less_than_5 = ifelse(.fittedPC1 < -5, TRUE, FALSE)))
p1 <- shared_dt %>%  
  ggplot(aes(x = .fittedPC1, y = .fittedPC2)) + 
  geom_point() + 
  coord_equal()

p2 <- ggplot() +  
  geom_sf(data = state_map, aes(geometry = geometry)) +
  geom_point(data = shared_dt, aes(x = long, y = lat), color = "red") + 
  coord_sf() + 
  theme_void()

bscols(ggplotly(p1), ggplotly(p2))
```



## Decomposition

```{r}
df_monthly <- df_daily %>% 
  zoom() %>% 
  mutate(ym = tsibble::yearmonth(date)) %>% 
  index_by(ym) %>% 
  summarise(tmax = mean(tmax, na.rm = TRUE),
            tmin = mean(tmin, na.rm = TRUE), 
            prcp = sum(prcp, na.rm = TRUE)) %>% 
  ungroup(ym) %>% 
  filter(year(ym) < 2021) %>% 
  mutate(year = as.factor(year(ym)),
         month = as.factor(month(ym)), 
         prcp = sqrt(prcp + 0.001))
```


Link monthly tmax with map


```{r}
smooth_plot <- df_monthly %>% 
  ggplot(aes(x = as.Date(ym), y = tmax, group = station)) + 
  stat_smooth(se = FALSE) # gam

smoother <- layer_data(smooth_plot) %>% 
  group_by(group) %>% 
  summarise(y_diff = max(y) - min(y))

df_tmax_smoother <- df_monthly %>% 
  global() %>% 
  bind_cols(smoother) %>% 
  arrange(-y_diff)

shared_dt <- df_tmax_smoother %>% 
  zoom() %>% 
  migrate(lat, long, y_diff) %>% 
  highlight_key(~station)

p1 <- shared_dt %>% 
  ggplot() + 
  geom_sf(data = state_map, aes(geometry = geometry)) +
  geom_point(aes(x = long, y = lat, color = y_diff, group = station)) + 
  theme_void()

map <- highlight(ggplotly(p1), selectize = TRUE, on = "plotly_selected")

p2 <- shared_dt %>% 
  ggplot(aes(x = as.Date(ym), y = tmax, group = station, color = y_diff), alpha = .1) + 
  geom_line()

line <- highlight(ggplotly(p2), on = "plotly_hover")

bscols(map, line)

```

See yearly variation of different stations

```{r}
df_into_month <- df_monthly %>% 
  group_by(month, station) %>% 
  summarise(tmax = mean(tmax, na.rm = TRUE),
            tmin = mean(tmin, na.rm = TRUE)) %>% 
  ungroup() %>% 
  left_join(meta(df_monthly)) %>% # a bit of hacky to get around with group_by
  global(station)
```

tmax

Inland stations have much larger monthly fluctuation of tmax, than the coast stations

```{r}
yearly_diff <- df_monthly %>% 
  group_by(year, station) %>% 
  mutate(yearly_diff = max(tmax) - min(tmax)) %>% 
  ungroup(year) %>% 
  mutate(yearly_diff = max(yearly_diff, na.rm = TRUE)) %>% 
  ungroup() %>% 
  select(station, yearly_diff) %>% 
  distinct()
  
tmax_data <- df_monthly %>% 
  global() %>% 
  left_join(yearly_diff) %>% 
  zoom() %>% 
  migrate(yearly_diff, lat, long, name) %>% 
  highlight_key(~station)
  

p1 <- tmax_data %>% 
    ggplot(aes(x = month, y = tmax, group = interaction(year, station), color = yearly_diff, label = name)) + 
    geom_line() + 
    facet_wrap(vars(fct_reorder(station, -yearly_diff))) + 
  theme(legend.position = "none")

p2 <- tmax_data %>% 
  ggplot() + 
  geom_sf(data = state_map, aes(geometry = geometry)) +
  geom_point(aes(x = long, y = lat, color = yearly_diff, label = name)) + 
  theme_void()

bscols(ggplotly(p1, height = 600, tooltip = "label"),
       ggplotly(p2, tooltip = "label"))
```

Temperature difference for stations

<!-- Summarises the monthly mean temperature across each year for all the stations and calculate the mean temperature difference. Plot the two averaged temperature series as line and on the map for each station.  -->

<!-- Those stations along the coastline are the ones with small temperature difference and this makes sense because water body has the effect to neutralise temperature.  -->

looks like some places a larger temperature difference during winter and smaller during summer (blue ones - those are the stations in the north) while others have the opposite pattern (red - those are the stations in the south)

```{r}
tdiff_data <- df_daily %>% 
  zoom() %>% 
  mutate(daily_diff = tmax - tmin,
         yearweek = yearweek(date)) %>% 
  index_by(yearweek) %>% 
  summarise(daily_diff = mean(daily_diff, na.rm  = TRUE)) %>% 
  ungroup(yearweek) %>% 
  mutate(year = year(yearweek),
         week = week(yearweek))

smoother <- tdiff_data %>% 
  ggplot(aes(x = week, y = daily_diff)) + 
  stat_smooth(aes(group = station), se = FALSE)

ydiff <- layer_data(smoother) %>% 
  group_by(group) %>% 
  filter(y == max(y) | y == min(y) ) %>% 
  mutate(diff = max(y) - min(y),
         label = ifelse(y == max(y), "max", "min")) %>% 
  pivot_wider(names_from = "label", 
              values_from = c("x", "y"), 
              names_sep = "") %>% 
  mutate(sign = ifelse(between(xmax, 0, 20) | between(xmax, 40, 53),
                               "pos", "neg"),
         ydiff = ifelse(sign == "pos", ymax - ymin, ymin - ymax)) %>% 
  bind_cols(station = unique(tdiff_data$station)) %>% 
  select(station, ydiff)


tdiff_smoother_data <- tdiff_data %>% 
  left_join(ydiff) %>%
  migrate(lat, long, name) %>% 
  highlight_key(~station)

p1 <- tdiff_smoother_data %>% 
  ggplot(aes(x = week, y = daily_diff, label = name)) + 
  geom_line(aes(group = interaction(station, year)), alpha = 0.5) + 
  geom_smooth(aes(group = station, color = ydiff), se = FALSE) + 
  facet_wrap(vars(fct_reorder(station, ydiff))) +
  scale_color_continuous_diverging(palette = "Blue-Red")


p2 <- tdiff_smoother_data %>% 
  ggplot() + 
  geom_sf(data = state_map, aes(geometry = geometry), alpha = 0.1) +
  geom_point(aes(x = long, y = lat, color = ydiff, label = name)) + 
  theme_void() + 
  scale_color_continuous_diverging(palette = "Blue-Red")

# p1 | p2
bscols(ggplotly(p1, height = 600, tooltip = "label"),
       ggplotly(p2, tooltip = "label"))

```

prcp

- summarise the weekly average across 2015 - 2020 for each station (compute on the time, hence zoom to the long form) 
- apply a square root transformation to adjust the scale
- compute the maximum average weekly rain for each station. Since the result is for each station, need to switch with `global()`
- migrate some variables to the long form. This makes sure that the dataset used for creating the time series plot and map are the same for cross-linking.   

Those with more rains are in the north or along the eastern coast

- add interactivity

```{r}
# average over all 5 years to avoid particular stations having no records of prcp in some weeks
# try with filter(year(date) == 2020) has a stronger effect on the north and eastern coast
prcp_data <- df_daily %>% 
  zoom() %>% 
  mutate(week = week(date)) %>% 
  index_by(week) %>% 
  summarise(prcp = mean(prcp, na.rm = TRUE)) %>% 
  ungroup(week)%>% 
  mutate(prcp = sqrt(prcp)) %>% 
  global() %>% 
  mutate(prcp_max = max(ts$prcp, na.rm = TRUE)) %>% 
  zoom() %>% 
  migrate(prcp_max, lat, long, name)

shared_data <- prcp_data %>% highlight_key(~station)

p1 <- shared_data %>% 
  ggplot(aes(x = week, y = prcp, group = name, color = prcp_max)) + 
  geom_line() + 
  facet_wrap(vars(fct_reorder(station, prcp_max, max, .desc = TRUE))) + 
  theme(legend.position = "none") + 
  colorspace::scale_color_continuous_sequential("Blues 3", c2 = 40, l2 = 80, c1 = 30, rev = FALSE)

p2 <- shared_data %>% 
  ggplot() + 
  geom_sf(data = state_map, aes(geometry = geometry), alpha = 0.1) +
  geom_point(aes(x = long, y = lat, group = name, color = prcp_max)) + 
  theme_void() + 
  colorspace::scale_color_continuous_sequential("Blues 3", c2 = 40, l2 = 80, c1 = 30, rev = FALSE)

# static
# (p1 | p2)

# interactive
bscols(ggplotly(p1, height = 600, tooltip = "group"),
       ggplotly(p2, tooltip = "group"))

# comment
# plotly::subplot() doesn't work well with the map - it shrinks to one point
# I was trying to use key = station in SharedData$new() to create a group but it doesn't work ... The default is to have each row as a group so the link from map to line doesn't work (shared_data <- SharedData$new(prcp_data, key = station))
```
  
The same thing on a glyph map

```{r}
glyph_data <- prcp_data %>% 
  GGally::glyphs("long", "week", "lat", "prcp", height = 0.8, width = 2)

ggplot(glyph_data, aes(gx, gy, group = gid)) + 
  geom_sf(data = state_map, aes(x = NULL, y = NULL, group = NULL, 
                                geometry = geometry), alpha = 0.1) +
  GGally::add_ref_lines(glyph_data, color = "grey90") +
  GGally::add_ref_boxes(glyph_data, color = "grey90") +
  geom_path(aes(color = prcp_max)) + 
  theme_void()

```

  

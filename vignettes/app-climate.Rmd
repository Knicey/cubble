---
title: "app-climate"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{app-climate}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  out.width = "100%"
)
```

```{r setup}
library(cubble)
library(tidyverse)
library(ggplot2)
library(fabletools)
library(broom)
library(feasts)
library(rmapshaper)
library(lubridate)
library(patchwork)
library(crosstalk)
library(plotly)
library(tsibble)
state_map <- ms_simplify(ozmaps::abs_ste, keep = 2e-3)
filter <- dplyr::filter
```

# Prelim

-   clean the `oz_climate`
-   for a peirod from 2015 - 2020
-   create a cubble object
-   filter out the stations that don't have `tmax` or `tmin` recorded and also some stations that don't have proper records

```{r}
df <- oz_climate %>% 
  mutate(name = as.factor(str_to_lower(str_remove(name, ", AS")))) %>% 
  filter(year(date) < 2021) %>% 
  as_tsibble(index = date, key = station) %>% 
  global(station) 
  
#  rename(elev = elevation)
# add rename: https://github.com/tidyverse/dplyr/blob/master/R/rename.R

df_daily <- df %>% 
  mutate(tmax_missing = all(is.na(ts$tmax)),
         tmin_missing = all(is.na(ts$tmin))) %>% 
  filter(!tmax_missing, !tmin_missing, 
         name != "coffs harbour mo",# too many missing from 2016 - 2020 for coffs harbour mo
         !station %in% c("ASN00016098", # almost all missing for tmin
                      "ASN00090015")  # have no prcp recorded (either 0 or NA)
         ) 
```

## A first glance on these series

A first overview of these series:

-   some have small variation across year, e.g. gove airport, kalumburu, townsville aero, weipa aero
-   some have strong yearly seasonality, e.g. deniliquin airport aws
-   some have more fluctuation in summer than winter, e.g. melbourne airport

```{r}
df_daily %>% 
  zoom() %>% 
  migrate(name) %>% 
  mutate(year = year(date),
         yday = yday(date),
         month = month(date)) %>% 
  ggplot(aes(x = yday ,y = tmax, group = interaction(station, year))) + 
  geom_line(alpha = 0.5) + 
  facet_wrap(vars(name))
```

## Location of all the stations

```{r}
ggplot() +  
  geom_sf(data = state_map, aes(geometry = geometry)) +
  geom_point(data = df, aes(x = long, y = lat)) + 
  coord_sf() + 
  theme_void()
```

# Features on the series

-   compute features on `tmax`
-   plot the first two PCs and its locations on the map
-   PCA diagnostics: too many variables from the features - want to subset to a smaller group

```{r eval = FALSE}
feat_tmax <- df_daily %>% 
  mutate(ts = list(as_tibble(ts))) %>% 
  tidyr::unnest(ts) %>% 
  as_tsibble(index = date, key = station) %>% 
  features(tmax, feature_set(pkgs = "feasts"))

feat_tmax_clean <- feat_tmax %>% 
  dplyr::select(-contains(c("lb", "bp", "zero", "pp", "diffs", "lambda", "pacf", "hurst")))

pca_res <- feat_tmax_clean %>% 
  dplyr::select(-station) %>% 
  prcomp(scale = TRUE) 

pca_tmax <- pca_res %>% 
  augment(feat_tmax_clean)
```

```{r eval = FALSE}
df_tmax_pca <- df_daily %>% 
  left_join(pca_tmax %>% dplyr::select(station, .fittedPC1, .fittedPC2)) %>% 
  highlight_key(~station)

p1 <- df_tmax_pca %>% 
  ggplot(aes(x = .fittedPC1, y = .fittedPC2, label = name, group = station)) + 
  geom_point() + 
  coord_equal()

p2 <- df_tmax_pca %>% 
  ggplot() +  
  geom_point(aes(x = long, y = lat, label = name, group = station)) + 
  geom_sf(data = state_map, aes(geometry = geometry), alpha = 0.1) +
  coord_sf() + 
  theme_void()

bscols(ggplotly(p1, width = 800, height = 800, tooltip = c("label", "group")) %>% 
         highlight(on = "plotly_selected", off = "plotly_deselect", color = "red"),
       ggplotly(p2,width = 800, height = 800, tooltip = c("label", "group")) %>% 
         highlight(on = "plotly_selected", off = "plotly_deselect", color = "red"))
```

```{r}
p3 <- pca_res %>% 
  tidy(matrix = "rotation") %>% 
  pivot_wider(names_from = "PC", names_prefix = "PC", values_from = "value") %>%
  ggplot(aes(PC1, PC2)) +
  geom_segment(xend = 0, yend = 0, 
               arrow = arrow(angle = 20, ends = "first", 
                             type = "closed", length = grid::unit(8, "pt"))) + 
  ggrepel::geom_text_repel(aes(label = column), nudge_x = -0.02) + 
  coord_fixed()

p4 <- pca_res %>% 
  tidy(matrix = "eigenvalues") %>% 
  ggplot(aes(PC, percent)) +
  geom_col() 

p3 | p4
```

### Repeat the same on prcp & tmin

```{r eval = FALSE}
df_prcp <- df %>% 
  mutate(prcp_missing = all(is.na(ts$prcp) | ts$prcp == 0)) %>% 
  filter(!prcp_missing) 

feat_prcp <- df_prcp %>% 
  tidyr::unnest(ts) %>% 
  as_tsibble(index = date, key = station) %>% 
  features(prcp, feature_set(pkgs = "feasts"))

feat_prcp_clean <- feat_prcp %>% 
  dplyr::select(-contains(c("lb", "bp", "zero", "pp", "diffs", "lambda", "pacf", "kpss", "hurst")))

pca_prcp <- feat_prcp_clean %>% 
  dplyr::select(-station) %>% 
  prcomp(scale = TRUE) %>% 
  augment(feat_prcp_clean)

df_prcp_pca <- df_prcp %>% 
  left_join(pca_prcp %>% dplyr::select(station, .fittedPC1, .fittedPC2)) 

df_prcp_pca %>% 
  ggplot(aes(x = .fittedPC1, y = .fittedPC2)) + 
  geom_point() + 
  coord_equal()

# see those stations on the map
ggplot() +  
  geom_sf(data = state_map, aes(geometry = geometry)) +
  geom_point(data = df, aes(x = long, y = lat)) + 
  geom_point(data = df_prcp_pca %>% filter(.fittedPC1 > 4), 
             aes(x = long, y = lat), color = "red") + 
  coord_sf() + 
  theme_minimal()

# plot the tmax series along with the average of all others
df_prcp_pca %>% 
  filter(.fittedPC1 > 4) %>% 
  zoom() %>% 
  migrate(name) %>% 
  ggplot(aes(x = date , y = prcp)) + 
  geom_line() + 
  facet_wrap(vars(name))

```

```{r eval = FALSE}
df_tmin <- df %>% 
  mutate(tmin_missing = all(is.na(ts$tmin)), 
         first_day = is.na(ts$tmin[1])) %>% 
  filter(!tmin_missing, !first_day) 

feat_tmin <- df_tmin %>% 
  tidyr::unnest(ts) %>% 
  as_tsibble(index = date, key = station) %>% 
  features(tmin, feature_set(pkgs = "feasts"))

feat_tmin_clean <- feat_tmin %>% 
  dplyr::select(-contains(c("lb", "bp", "zero", "pp", "diffs", "lambda", "pacf", "hurst", "kpss", "spikiness"))) %>% 
  filter(station != "ASN00040223")

pca_tmin <- feat_tmin_clean %>% 
  dplyr::select(-station) %>% 
  prcomp(scale = TRUE) %>% 
  augment(feat_tmin_clean)

df_tmin_pca <- df_tmin %>% 
  left_join(pca_tmin %>% dplyr::select(station, .fittedPC1, .fittedPC2)) 

df_tmin_pca %>% 
  ggplot(aes(x = .fittedPC1, y = .fittedPC2)) + 
  geom_point() + 
  coord_equal()

# see those stations on the map
ggplot() +  
  geom_sf(data = ozmaps::abs_ste, aes(geometry = geometry)) +
  geom_point(data = df, aes(x = long, y = lat)) + 
  geom_point(data = df_tmin_pca %>% filter(.fittedPC1 > 6), 
             aes(x = long, y = lat), color = "red") + 
  coord_sf() + 
  theme_minimal()
```

# Plot & aggregate series in various different ways

-   aggregate to monthly measure

```{r}
df_monthly <- df_daily %>% 
  zoom() %>% 
  mutate(ym = tsibble::yearmonth(date)) %>% 
  index_by(ym) %>% 
  summarise(tmax = mean(tmax, na.rm = TRUE),
            tmin = mean(tmin, na.rm = TRUE), 
            prcp = sum(prcp, na.rm = TRUE)) %>% 
  ungroup(ym) %>%
  mutate(year = as.factor(year(ym)),
         month = as.factor(month(ym)), 
         prcp = sqrt(prcp + 0.001))
```

## Maximum temperature by month 

-   break the series by year for each station

-   ordered by the median tmax

-   We learn that, obviously, those in the north have higher median tmax

```{r}
median_tmax <- df_monthly %>% 
  mutate(median_tmax = median(tmax, na.rm = TRUE)) %>% 
  select(station, median_tmax) %>% 
  distinct()

tmax_data <- df_monthly %>% 
  global(station) %>% 
  left_join(median_tmax) %>% 
  zoom() %>% 
  migrate(median_tmax, lat, long, name) %>% 
  highlight_key(~station)

p1 <- tmax_data %>% 
    ggplot(aes(x = month, y = tmax, group = interaction(year, station), 
               color = median_tmax, label = name)) + 
    geom_line() + 
    facet_wrap(vars(fct_reorder(station, -median_tmax))) + 
  theme(legend.position = "none")

p2 <- tmax_data %>% 
  ggplot() + 
  geom_sf(data = state_map, aes(geometry = geometry)) +
  geom_point(aes(x = long, y = lat, color = median_tmax, label = name)) + 
  theme_void()

bscols(ggplotly(p1, width = 800, height = 800, tooltip = "label") %>% 
         highlight(on = "plotly_selected", off = "plotly_deselect", color = "red"),
       ggplotly(p2,width = 800, height = 800, tooltip = "label") %>% 
         highlight(on = "plotly_selected", off = "plotly_deselect", color = "red")
```

-   order by the maximum yearly temperature difference

    -   large value means there is a large max temperature difference between summer & winter

-   We learn that those have large max temperature difference in the year are the inland stations

```{r eval = FALSE}
yearly_diff <- df_monthly %>% 
  group_by(year, station) %>% 
  mutate(yearly_diff = max(tmax) - min(tmax)) %>% 
  ungroup(year) %>% 
  mutate(yearly_diff = max(yearly_diff, na.rm = TRUE)) %>% 
  ungroup() %>% 
  select(station, yearly_diff) %>% 
  distinct()
  
tmax_data <- df_monthly %>% 
  global(station) %>% 
  left_join(yearly_diff) %>% 
  zoom() %>% 
  migrate(yearly_diff, lat, long, name) %>% 
  highlight_key(~station)
  
p1 <- tmax_data %>% 
    ggplot(aes(x = month, y = tmax, group = interaction(year, station), 
               color = yearly_diff, label = name)) + 
    geom_line() + 
    facet_wrap(vars(fct_reorder(station, -yearly_diff))) + 
  theme(legend.position = "none")

p2 <- tmax_data %>% 
  ggplot() + 
  geom_sf(data = state_map, aes(geometry = geometry)) +
  geom_point(aes(x = long, y = lat, color = yearly_diff, label = name)) + 
  theme_void()

bscols(ggplotly(p1, width = 800, height = 800, tooltip = "label") %>% 
         highlight(on = "plotly_selected", off = "plotly_deselect", color = "red"),
       ggplotly(p2,width = 800, height = 800, tooltip = "label") %>% 
         highlight(on = "plotly_selected", off = "plotly_deselect", color = "red"))
```

## Temperature difference of the day

-   calculate the daily temperature difference and take average of each week

-   add a smoother

-   order by the median difference

-   we learn that those stations close to the coast have smaller day-and-night temperature difference. Those stations are closer to the water, which has a moderating effect on the change of temperature

```{r eval = FALSE}
tdiff_data <- df_daily %>% 
  zoom() %>% 
  mutate(daily_diff = tmax - tmin,
         yearweek = yearweek(date)) %>% 
  index_by(yearweek) %>% 
  summarise(daily_diff = mean(daily_diff, na.rm  = TRUE)) %>% 
  ungroup(yearweek) %>% 
  mutate(year = year(yearweek),
         week = week(yearweek))

smoother <- tdiff_data %>% 
  ggplot(aes(x = week, y = daily_diff)) + 
  stat_smooth(aes(group = station), se = FALSE)

median_y <- layer_data(smoother) %>% 
  group_by(group) %>% 
  mutate(median_y = median(y, na.rm = TRUE)) %>% 
  select(group, median_y) %>% 
  distinct() %>% 
  bind_cols(station = unique(tdiff_data$station)) %>% 
  select(station, median_y)


tdiff_smoother_data <- tdiff_data %>% 
  left_join(median_y) %>%
  migrate(lat, long, name) %>% 
  highlight_key(~station)

p1 <- tdiff_smoother_data %>% 
  ggplot(aes(x = week, y = daily_diff, label = name)) + 
  geom_line(aes(group = interaction(station, year)), alpha = 0.2, size = 0.5) + 
  geom_smooth(aes(group = station, color = median_y), se = FALSE) + 
  facet_wrap(vars(fct_reorder(station, -median_y))) + 
  colorspace::scale_color_continuous_sequential("Reds 3", l1 = 30,  l2 = 100, c1 = 30, rev = FALSE)


p2 <- tdiff_smoother_data %>% 
  ggplot() + 
  geom_sf(data = state_map, aes(geometry = geometry), alpha = 0.1) +
  geom_point(aes(x = long, y = lat, color = median_y, label = name)) + 
  theme_void() + 
  colorspace::scale_color_continuous_sequential("Reds 3",l1 = 30,  l2 = 100, rev = FALSE)

# p1 | p2
bscols(ggplotly(p1, width = 800, height = 800, tooltip = "label") %>% 
         highlight(on = "plotly_selected", off = "plotly_deselect", color = "red"),
       ggplotly(p2,width = 800, height = 800, tooltip = "label") %>% 
         highlight(on = "plotly_selected", off = "plotly_deselect", color = "red"))
```

-   order by the largest difference of the smoother (negative if peak in the middle and positive if trough in the middle)

    -   a value close to zero means the area has a constant day and night temperature difference

    -   a positive value means the temperature difference is smaller in winter

    -   a negative value means the temperature difference is larger in winter

-   It looks like those with positive difference are in the south and negative diff in the north

```{r eval = FALSE}
tdiff_data <- df_daily %>% 
  zoom() %>% 
  mutate(daily_diff = tmax - tmin,
         yearweek = yearweek(date)) %>% 
  index_by(yearweek) %>% 
  summarise(daily_diff = mean(daily_diff, na.rm  = TRUE)) %>% 
  ungroup(yearweek) %>% 
  mutate(year = year(yearweek),
         week = week(yearweek))

smoother <- tdiff_data %>% 
  ggplot(aes(x = week, y = daily_diff)) + 
  stat_smooth(aes(group = station), se = FALSE)

ydiff <- layer_data(smoother) %>% 
  group_by(group) %>% 
  filter(y == max(y) | y == min(y) ) %>% 
  mutate(diff = max(y) - min(y),
         label = ifelse(y == max(y), "max", "min")) %>% 
  pivot_wider(names_from = "label", 
              values_from = c("x", "y"), 
              names_sep = "") %>% 
  mutate(sign = ifelse(between(xmax, 0, 20) | between(xmax, 40, 53),
                               "pos", "neg"),
         ydiff = ifelse(sign == "pos", ymax - ymin, ymin - ymax)) %>% 
  bind_cols(station = unique(tdiff_data$station)) %>% 
  select(station, ydiff)


tdiff_smoother_data <- tdiff_data %>% 
  left_join(ydiff) %>%
  migrate(lat, long, name) %>% 
  highlight_key(~station)

p1 <- tdiff_smoother_data %>% 
  ggplot(aes(x = week, y = daily_diff, label = name)) + 
  geom_line(aes(group = interaction(station, year)), alpha = 0.2, size = 0.5) + 
  geom_smooth(aes(group = station, color = ydiff), se = FALSE) + 
  facet_wrap(vars(fct_reorder(station, ydiff))) +
  scale_color_continuous_diverging(palette = "Blue-Red")


p2 <- tdiff_smoother_data %>% 
  ggplot() + 
  geom_sf(data = state_map, aes(geometry = geometry), alpha = 0.1) +
  geom_point(aes(x = long, y = lat, color = ydiff, label = name)) + 
  theme_void() + 
  scale_color_continuous_diverging(palette = "Blue-Red")

# p1 | p2
bscols(ggplotly(p1, width = 800, height = 800, tooltip = "label") %>% 
         highlight(on = "plotly_selected", off = "plotly_deselect", color = "red"),
       ggplotly(p2,width = 800, height = 800, tooltip = "label") %>% 
         highlight(on = "plotly_selected", off = "plotly_deselect", color = "red"))

```

## Weekly precipitation

-   summarise the weekly average across 2015 - 2020 for each station then square root transformation
-   ordered by the maximum weekly prcp
-   we learn that those with more rains are in the north or along the eastern coast

```{r eval = FALSE}
# average over all 5 years to avoid particular stations having no records of prcp in some weeks
# try with filter(year(date) == 2020) has a stronger effect on the north and eastern coast
prcp_data <- df_daily %>% 
  zoom() %>% 
  mutate(week = week(date)) %>% 
  index_by(week) %>% 
  summarise(prcp = mean(prcp, na.rm = TRUE)) %>% 
  ungroup(week)%>% 
  mutate(prcp = sqrt(prcp)) %>% 
  global() %>% 
  mutate(prcp_max = max(ts$prcp, na.rm = TRUE)) %>% 
  zoom() %>% 
  migrate(prcp_max, lat, long, name)

shared_data <- prcp_data %>% highlight_key(~station)

p1 <- shared_data %>% 
  ggplot(aes(x = week, y = prcp, group = name, color = prcp_max)) + 
  geom_line() + 
  facet_wrap(vars(fct_reorder(station, prcp_max, max, .desc = TRUE))) + 
  theme(legend.position = "none") + 
  colorspace::scale_color_continuous_sequential("Blues 3", c2 = 40, l2 = 80, c1 = 30, rev = FALSE)

p2 <- shared_data %>% 
  ggplot() + 
  geom_sf(data = state_map, aes(geometry = geometry), alpha = 0.1) +
  geom_point(aes(x = long, y = lat, group = name, color = prcp_max)) + 
  theme_void() + 
  colorspace::scale_color_continuous_sequential("Blues 3", c2 = 40, l2 = 80, c1 = 30, rev = FALSE)

# static
# (p1 | p2)

# interactive
bscols(ggplotly(p1, width = 800, height = 800, tooltip = "label") %>% 
         highlight(on = "plotly_selected", off = "plotly_deselect", color = "red"),
       ggplotly(p2,width = 800, height = 800, tooltip = "label") %>% 
         highlight(on = "plotly_selected", off = "plotly_deselect", color = "red"))


# notes to my self
# plotly::subplot() doesn't work well with the map - it shrinks to one point
# I was trying to use key = station in SharedData$new() to create a group but it doesn't work ... The default is to have each row as a group so the link from map to line doesn't work (shared_data <- SharedData$new(prcp_data, key = station))
```

The same thing on a glyph map

```{r eval = FALSE}
glyph_data <- prcp_data %>% 
  GGally::glyphs("long", "week", "lat", "prcp", height = 0.8, width = 2)

ggplot(glyph_data, aes(gx, gy, group = gid)) + 
  geom_sf(data = state_map, aes(x = NULL, y = NULL, group = NULL, 
                                geometry = geometry), alpha = 0.1) +
  GGally::add_ref_lines(glyph_data, color = "grey90") +
  GGally::add_ref_boxes(glyph_data, color = "grey90") +
  geom_path(aes(color = prcp_max)) + 
  theme_void()

```
